<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Night Reading</title>

  <meta name="theme-color" content="#111111">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <link rel="manifest" href="./manifest.webmanifest">

  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:24px;max-width:720px}
    h1{margin:0 0 6px 0}
    .muted{color:#666}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin:14px 0}
    button{
      padding:10px 12px;border:1px solid #ddd;border-radius:12px;background:transparent;cursor:pointer
    }
    button:active{transform:scale(0.99)}
    .card{border:1px solid #ddd;border-radius:16px;padding:16px;margin:12px 0}
    a.button{
      display:block; padding:14px 16px; border:1px solid #ddd; border-radius:14px;
      text-decoration:none; margin-top:10px;
      word-break:break-word;
    }
    a.button:active{transform:scale(0.99)}
    .doneRow{display:flex;align-items:center;gap:10px;margin-top:10px}
    .pill{display:inline-block;padding:4px 10px;border:1px solid #ddd;border-radius:999px;font-size:12px}
    .error{color:#b00020}
  </style>
</head>

<body>
  <h1>Night Reading</h1>
  <div class="muted" id="date"></div>
  <div class="muted" id="weekOf"></div>
  <div class="row">
    <button id="openAll">Open all</button>
    <button id="copyLinks">Copy links</button>
    <span class="pill" id="offlinePill" style="display:none;">Offline</span>
  </div>

  <div class="card">
    <h2>Poem</h2>
    <a class="button" id="poem" href="#" target="_blank" rel="noreferrer"></a>
    <div class="doneRow">
      <input type="checkbox" id="poemDone">
      <label for="poemDone">Done</label>
    </div>
  </div>

  <div class="card">
    <h2>Short story</h2>
    <a class="button" id="story" href="#" target="_blank" rel="noreferrer"></a>
    <div class="doneRow">
      <input type="checkbox" id="storyDone">
      <label for="storyDone">Done</label>
    </div>
  </div>

  <div class="card">
    <h2>Essay</h2>
    <a class="button" id="essay" href="#" target="_blank" rel="noreferrer"></a>
    <div class="doneRow">
      <input type="checkbox" id="essayDone">
      <label for="essayDone">Done</label>
    </div>
  </div>

  <div class="muted" id="status"></div>

<script>
  // --- Service worker registration (PWA/offline) ---
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./service-worker.js");
  }

  const $ = (id) => document.getElementById(id);

  function setLink(id, item) {
    const a = $(id);
    a.textContent = item.title;
    a.href = item.url;
  }

  function keyForToday() {
    const d = new Date();
    // YYYY-MM-DD local
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd}`;
  }

  function bindDone(id, storageKey) {
    const box = $(id);
    box.checked = localStorage.getItem(storageKey) === "1";
    box.addEventListener("change", () => {
      localStorage.setItem(storageKey, box.checked ? "1" : "0");
    });
  }

  function updateOfflineUI() {
    $("offlinePill").style.display = navigator.onLine ? "none" : "inline-block";
  }
  window.addEventListener("online", updateOfflineUI);
  window.addEventListener("offline", updateOfflineUI);

  async function loadWeek() {
    $("date").textContent = new Date().toDateString();
    updateOfflineUI();

    let data;
    try {
      const res = await fetch("./week.json", { cache: "no-store" });
      if (!res.ok) throw new Error("Failed to load week.json");
      data = await res.json();
    } catch (e) {
      $("status").innerHTML = `<span class="error">Could not load week.json (offline or missing file).</span>`;
      return;
    }

    $("weekOf").textContent = data.weekOf ? `Week of ${data.weekOf}` : "";

    const day = new Date().getDay(); // Sun=0..Sat=6
    const todays = data.days?.[String(day)];
    if (!todays) {
      $("status").innerHTML = `<span class="error">No entry found for day ${day} in week.json</span>`;
      return;
    }

    setLink("poem", todays.poem);
    setLink("story", todays.story);
    setLink("essay", todays.essay);

    // Done checkboxes saved per date
    const todayKey = keyForToday();
    bindDone("poemDone",  `done:${todayKey}:poem`);
    bindDone("storyDone", `done:${todayKey}:story`);
    bindDone("essayDone", `done:${todayKey}:essay`);

    $("openAll").onclick = () => {
      window.open(todays.poem.url,  "_blank", "noreferrer");
      window.open(todays.story.url, "_blank", "noreferrer");
      window.open(todays.essay.url, "_blank", "noreferrer");
    };

    $("copyLinks").onclick = async () => {
      const text =
`Tonight's Reading (${todayKey})
Poem: ${todays.poem.title} — ${todays.poem.url}
Story: ${todays.story.title} — ${todays.story.url}
Essay: ${todays.essay.title} — ${todays.essay.url}`;
      try {
        await navigator.clipboard.writeText(text);
        $("status").textContent = "Copied.";
        setTimeout(()=>{$("status").textContent="";}, 1200);
      } catch {
        $("status").innerHTML = `<span class="error">Clipboard blocked by browser. Copy manually.</span>`;
      }
    };
  }

  loadWeek();
</script>
</body>
</html>
