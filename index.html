<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Night Reading</title>

  <meta name="theme-color" content="#111111">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <link rel="manifest" href="./manifest.webmanifest">

  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:24px;max-width:720px}
    h1{margin:0 0 6px 0}
    .muted{color:#666}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin:14px 0;align-items:center}
    button, select{
      padding:10px 12px;border:1px solid #ddd;border-radius:12px;background:transparent;cursor:pointer
    }
    button:active{transform:scale(0.99)}
    .card{border:1px solid #ddd;border-radius:16px;padding:16px;margin:12px 0}
    a.button{
      display:block; padding:14px 16px; border:1px solid #ddd; border-radius:14px;
      text-decoration:none; margin-top:10px; word-break:break-word;
    }
    a.button:active{transform:scale(0.99)}
    .doneRow{display:flex;align-items:center;gap:10px;margin-top:10px}
    .pill{display:inline-block;padding:4px 10px;border:1px solid #ddd;border-radius:999px;font-size:12px}
    .error{color:#b00020}
  </style>
</head>

<body>
  <h1>Night Reading</h1>
  <div class="muted" id="date"></div>
  <div class="muted" id="viewing"></div>

  <div class="row">
    <button id="openAll">Open all</button>
    <button id="copyLinks">Copy links</button>
    <span class="pill" id="offlinePill" style="display:none;">Offline</span>
  </div>

  <div class="row">
    <span class="pill">Archive</span>
    <select id="archiveSelect" style="min-width:220px">
      <option value="">Loading…</option>
    </select>
    <button id="goWeek">Go</button>
  </div>

  <div class="card">
    <h2>Poem</h2>
    <a class="button" id="poem" href="#" target="_blank" rel="noreferrer"></a>
    <div class="doneRow">
      <input type="checkbox" id="poemDone">
      <label for="poemDone">Done</label>
    </div>
  </div>

  <div class="card">
    <h2>Short story</h2>
    <a class="button" id="story" href="#" target="_blank" rel="noreferrer"></a>
    <div class="doneRow">
      <input type="checkbox" id="storyDone">
      <label for="storyDone">Done</label>
    </div>
  </div>

  <div class="card">
    <h2>Essay</h2>
    <a class="button" id="essay" href="#" target="_blank" rel="noreferrer"></a>
    <div class="doneRow">
      <input type="checkbox" id="essayDone">
      <label for="essayDone">Done</label>
    </div>
  </div>

  <div class="muted" id="status"></div>

<script>
  // --- Service worker registration (PWA/offline) ---
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./service-worker.js");
  }

  const $ = (id) => document.getElementById(id);

  function formatYMD(d){
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd}`;
  }

  function startOfWeekSunday(d){
    const x = new Date(d);
    x.setHours(0,0,0,0);
    x.setDate(x.getDate() - x.getDay()); // Sun=0
    return x;
  }

  function keyForToday() {
    return formatYMD(new Date());
  }

  function setLink(id, item) {
    const a = $(id);
    a.textContent = item.title;
    a.href = item.url;
  }

  function bindDone(id, storageKey) {
    const box = $(id);
    box.checked = localStorage.getItem(storageKey) === "1";
    box.addEventListener("change", () => {
      localStorage.setItem(storageKey, box.checked ? "1" : "0");
    });
  }

  function updateOfflineUI() {
    $("offlinePill").style.display = navigator.onLine ? "none" : "inline-block";
  }
  window.addEventListener("online", updateOfflineUI);
  window.addEventListener("offline", updateOfflineUI);

  async function fetchJson(path){
    const res = await fetch(path, { cache: "no-store" });
    if (!res.ok) throw new Error(`Failed ${path} (${res.status})`);
    return res.json();
  }

  async function loadArchiveIndex(selectedWeek){
    const sel = $("archiveSelect");
    try {
      const idx = await fetchJson("./weeks/index.json");
      const weeks = (idx && idx.weeks) ? idx.weeks : [];

      sel.innerHTML = "";
      if (!weeks.length){
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "No archived weeks yet";
        sel.appendChild(opt);
        return;
      }

      // newest first
      weeks.slice().sort((a,b)=> (a.weekOf < b.weekOf ? 1 : -1)).forEach(w=>{
        const opt = document.createElement("option");
        opt.value = w.weekOf;
        opt.textContent = w.label || `Week of ${w.weekOf}`;
        if (w.weekOf === selectedWeek) opt.selected = true;
        sel.appendChild(opt);
      });
    } catch {
      sel.innerHTML = "<option value=''>Archive unavailable</option>";
    }
  }

  async function loadWeekData(weekOf){
    // Prefer archived file: /weeks/YYYY-MM-DD.json
    try {
      return await fetchJson(`./weeks/${weekOf}.json`);
    } catch {
      // Fallback to root week.json if you keep it
      return await fetchJson("./week.json");
    }
  }

  function setQueryWeek(weekOf){
    const u = new URL(window.location.href);
    u.searchParams.set("week", weekOf);
    window.location.href = u.toString();
  }

  async function init(){
    $("date").textContent = new Date().toDateString();
    updateOfflineUI();

    const params = new URLSearchParams(window.location.search);
    const autoWeek = formatYMD(startOfWeekSunday(new Date()));
    const selectedWeek = params.get("week") || autoWeek;

    await loadArchiveIndex(selectedWeek);

    $("goWeek").onclick = () => {
      const w = $("archiveSelect").value;
      if (w) setQueryWeek(w);
    };

    let data;
    try {
      data = await loadWeekData(selectedWeek);
    } catch (e) {
      $("status").innerHTML = `<span class="error">Could not load week data.</span>`;
      return;
    }

    const effectiveWeek = data.weekOf || selectedWeek;
    $("viewing").textContent = `Viewing week of ${effectiveWeek}`;

    const day = new Date().getDay(); // Sun=0..Sat=6
    const todays = data.days?.[String(day)];
    if (!todays) {
      $("status").innerHTML = `<span class="error">No entry found for day ${day} in this week file.</span>`;
      return;
    }

    setLink("poem", todays.poem);
    setLink("story", todays.story);
    setLink("essay", todays.essay);

    // Done checkboxes saved per real date (what you read tonight)
    const todayKey = keyForToday();
    bindDone("poemDone",  `done:${todayKey}:poem`);
    bindDone("storyDone", `done:${todayKey}:story`);
    bindDone("essayDone", `done:${todayKey}:essay`);

    $("openAll").onclick = () => {
      window.open(todays.poem.url,  "_blank", "noreferrer");
      window.open(todays.story.url, "_blank", "noreferrer");
      window.open(todays.essay.url, "_blank", "noreferrer");
    };

    $("copyLinks").onclick = async () => {
      const text =
`Tonight's Reading (${todayKey}) — Week of ${effectiveWeek}
Poem: ${todays.poem.title} — ${todays.poem.url}
Story: ${todays.story.title} — ${todays.story.url}
Essay: ${todays.essay.title} — ${todays.essay.url}`;
      try {
        await navigator.clipboard.writeText(text);
        $("status").textContent = "Copied.";
        setTimeout(()=>{$("status").textContent="";}, 1200);
      } catch {
        $("status").innerHTML = `<span class="error">Clipboard blocked by browser. Copy manually.</span>`;
      }
    };
  }

  init();
</script>
</body>
</html>
